import React, { useEffect, useState, useRef } from "react";
import generateQRCode from "../utils/generateQRCode";
import uploadPhoto from "../utils/uploadPhoto";
import {
  createDriveSubFolder,
  uploadImageToDrive,
  initializeGapi // ËøΩÂä†ÔºÅ
} from "../utils/googleDriveUtils";

import StitchButton from "../atoms/StitchButton";
import { database } from '../../firebase';
import { ref, push, set } from 'firebase/database';

const CLIENT_ID = process.env.REACT_APP_GOOGLE_CLIENT_ID;
const PARENT_FOLDER_ID = process.env.REACT_APP_FOLDER_ID;

function Camera() {
  const videoRef = useRef(null);
  const canvasRef = useRef(null);
  const [stream, setStream] = useState(null);
  const [showCameraModal, setShowCameraModal] = useState(false);
  const [accessToken, setAccessToken] = useState(null);
  const [imagePreviewUrl, setImagePreviewUrl] = useState(null);
  const [folderName, setFolderName] = useState(null);
  const tokenClientRef = useRef(null); // useState„Åã„ÇâuseRef„Å´Â§âÊõ¥
  const [photoDataUrl, setPhotoDataUrl] = useState(null); // ÂÜôÁúü„Éá„Éº„Çø‰øùÊåÅÁî®
  const [isUploading, setIsUploading] = useState(false); // „Ç¢„ÉÉ„Éó„É≠„Éº„Éâ‰∏≠„Åã
  const [photoCount, setPhotoCount] = useState(1); // ‰∫∫Êï∞ÈÅ∏ÊäûÁî®
  const [countdown, setCountdown] = useState(null); // PCÊíÆÂΩ±ÊôÇ„ÅÆ„Ç´„Ç¶„É≥„Éà„ÉÄ„Ç¶„É≥Áî®
  const [showFlash, setShowFlash] = useState(false); // PCÊíÆÂΩ±ÊôÇ„ÅÆ„Éï„É©„ÉÉ„Ç∑„É•Áî®
  const [showLargePreview, setShowLargePreview] = useState(false); // PCÊíÆÂΩ±Âæå„ÅÆ„Éó„É¨„Éì„É•„ÉºË°®Á§∫Áî®
  const [showCountdownEffect, setShowCountdownEffect] = useState(false); // „Ç´„Ç¶„É≥„Éà„ÉÄ„Ç¶„É≥‰∏≠„ÅÆ„Ç®„Éï„Çß„ÇØ„ÉàÁî®
  const shutterSoundRef = useRef(null); // „Ç∑„É£„ÉÉ„Çø„ÉºÈü≥Áî®„ÅÆref
  const countSoundRef = useRef(null); // „Ç´„Ç¶„É≥„Éà„ÉÄ„Ç¶„É≥Èü≥Áî®„ÅÆref
  const countdown54321SoundRef = useRef(null); // 54321„Ç´„Ç¶„É≥„Éà„ÉÄ„Ç¶„É≥Èü≥Áî®„ÅÆref
  const [aspectRatio, setAspectRatio] = useState('4:3'); // „Ç¢„Çπ„Éö„ÇØ„ÉàÊØî„ÅÆÁä∂ÊÖã

  useEffect(() => {
    // Google Identity Services „ÇØ„É©„Ç§„Ç¢„É≥„Éà„ÇíÂàùÊúüÂåñ
    if (window.google && !tokenClientRef.current) { // .current„Åß„Ç¢„ÇØ„Çª„Çπ
      const client = window.google.accounts.oauth2.initTokenClient({
        client_id: CLIENT_ID,
        scope: "https://www.googleapis.com/auth/drive.file",
        callback: (tokenResponse) => {
          if (tokenResponse && tokenResponse.access_token) {
            setAccessToken(tokenResponse.access_token);
            console.log("‚úÖ Google„É≠„Ç∞„Ç§„É≥ÊàêÂäü");
          }
        },
      });
      tokenClientRef.current = client; // ref„Å´Ê†ºÁ¥ç
    }
    // „Ç∑„É£„ÉÉ„Çø„ÉºÈü≥„Çí„Éó„É™„É≠„Éº„Éâ
    shutterSoundRef.current = new Audio('/shutter.mp3');
    shutterSoundRef.current.load(); // Âøµ„ÅÆ„Åü„ÇÅ„Éó„É™„É≠„Éº„Éâ„ÇíÊòéÁ§∫
    // „Ç´„Ç¶„É≥„Éà„ÉÄ„Ç¶„É≥Èü≥„Çí„Éó„É™„É≠„Éº„Éâ
    countSoundRef.current = new Audio('/count.mp3');
    countSoundRef.current.load();
    // 54321„Ç´„Ç¶„É≥„Éà„ÉÄ„Ç¶„É≥Èü≥„Çí„Éó„É™„É≠„Éº„Éâ
    countdown54321SoundRef.current = new Audio('/54321.mp3');
    countdown54321SoundRef.current.load();
  }, []);

  // „Ç´„Ç¶„É≥„Éà„ÉÄ„Ç¶„É≥„Å´Âêà„Çè„Åõ„Å¶ÁôΩ„ÅÑ„Ç®„Éï„Çß„ÇØ„Éà„Å®Èü≥„ÇíÂà∂Âæ°„Åô„Çã
  useEffect(() => {
    // „Ç´„Ç¶„É≥„Éà„ÉÄ„Ç¶„É≥„ÅåÈñãÂßã„Åï„Çå„ÄÅ0„Çà„ÇäÂ§ß„Åç„ÅÑÂ†¥Âêà
    if (countdown !== null && countdown > 0) {
      setShowCountdownEffect(true); // „Ç®„Éï„Çß„ÇØ„Éà„ÇíË°®Á§∫

      // „Ç´„Ç¶„É≥„ÉàÈü≥„ÇíÂÜçÁîü
      if (countSoundRef.current) {
        countSoundRef.current.currentTime = 0;
        countSoundRef.current.play().catch(e => console.error("„Ç´„Ç¶„É≥„Éà„ÉÄ„Ç¶„É≥Èü≥„ÅÆÂÜçÁîü„Å´Â§±Êïó:", e));
      }

      // 150„Éü„É™ÁßíÂæå„Å´„Ç®„Éï„Çß„ÇØ„Éà„ÇíÈùûË°®Á§∫„Å´„Åô„Çã
      const timer = setTimeout(() => {
        setShowCountdownEffect(false);
      }, 150);

      return () => clearTimeout(timer); // „ÇØ„É™„Éº„É≥„Ç¢„ÉÉ„Éó
    }
  }, [countdown]);

  // „Ç¢„Çπ„Éö„ÇØ„ÉàÊØî„ÅÆÂ§âÊõ¥„ÇíÁõ£Ë¶ñ„Åó„Å¶„Ç´„É°„É©„ÇíÂÜçËµ∑Âãï
  useEffect(() => {
      // „Ç´„É°„É©„É¢„Éº„ÉÄ„É´„ÅåË°®Á§∫„Åï„Çå„Å¶„ÅÑ„ÇãÂ†¥Âêà„ÅÆ„ÅøÂÜçËµ∑Âãï„Åô„Çã
      if (showCameraModal) {
          startCamera();
      }
      // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [aspectRatio]);

  const handleLogin = () => {
    if (tokenClientRef.current) {
      tokenClientRef.current.requestAccessToken();
    }
  };

  const startCamera = async () => {
    setShowCameraModal(true);
    // Êó¢Â≠ò„ÅÆ„Çπ„Éà„É™„Éº„É†„Åå„ÅÇ„Çå„Å∞ÂÅúÊ≠¢
    if (stream) {
      stream.getTracks().forEach(track => track.stop());
    }

    const videoConstraints = aspectRatio === '4:3'
      ? { width: { ideal: 1440 }, height: { ideal: 1080 } }
      : { width: { ideal: 810 }, height: { ideal: 1080 } };

    // facingMode„Çí 'user' („Ç§„É≥„Ç´„É°„É©) „Å´Âõ∫ÂÆö
    const constraints = {
      video: {
        ...videoConstraints,
        facingMode: 'user'
      },
      audio: false
    };
    try {
      const newStream = await navigator.mediaDevices.getUserMedia(constraints);
      setStream(newStream);
    } catch (err) {
      console.error("„Ç´„É°„É©„ÅÆËµ∑Âãï„Å´Â§±Êïó:", err);
      alert("„Ç´„É°„É©„ÅÆËµ∑Âãï„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ„Éñ„É©„Ç¶„Ç∂„ÅÆ„Ç´„É°„É©„Ç¢„ÇØ„Çª„ÇπË®±ÂèØ„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ");
      setShowCameraModal(false);
    }
  };

  // „Ç¢„Çπ„Éö„ÇØ„ÉàÊØî„ÇíÂàá„ÇäÊõø„Åà„Å¶„Ç´„É°„É©„ÇíÂÜçËµ∑Âãï
  const handleToggleAspectRatio = () => {
    setAspectRatio(prev => (prev === '4:3' ? '3:4' : '4:3'));
  }

  const stopCamera = () => {
    if (stream) {
      stream.getTracks().forEach(track => track.stop());
      setStream(null);
    }
    setCountdown(null); // „Ç´„Ç¶„É≥„Éà„ÉÄ„Ç¶„É≥„Çí„É™„Çª„ÉÉ„Éà
    setShowFlash(false); // „Éï„É©„ÉÉ„Ç∑„É•„ÇíÈùûË°®Á§∫„Å´
    setShowCameraModal(false);
  };

  const capturePhoto = () => {
    if (videoRef.current && canvasRef.current) {
      const video = videoRef.current;
      const canvas = canvasRef.current;
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      const context = canvas.getContext('2d');

      // „Ç∑„É£„ÉÉ„Çø„ÉºÈü≥„ÇíÂÜçÁîü
      if (shutterSoundRef.current) {
        shutterSoundRef.current.currentTime = 0; // ÂÜçÁîü‰ΩçÁΩÆ„ÇíÊúÄÂàù„Å´Êàª„Åô
        shutterSoundRef.current.play().catch(e => console.error("„Ç∑„É£„ÉÉ„Çø„ÉºÈü≥„ÅÆÂÜçÁîü„Å´Â§±Êïó:", e));
      }

      context.drawImage(video, 0, 0, video.videoWidth, video.videoHeight);
      const dataUrl = canvas.toDataURL('image/jpeg', 0.9);
      setImagePreviewUrl(dataUrl);
      setPhotoDataUrl(dataUrl);
      setFolderName(null);
      // PC„ÅÆÂ†¥Âêà„ÄÅÂ§ß„Åç„Å™„Éó„É¨„Éì„É•„Éº„ÇíË°®Á§∫„Åô„Çã
      const isPC = !/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
      if (isPC) {
        setShowLargePreview(true);
        setShowFlash(false); // „Éï„É©„ÉÉ„Ç∑„É•„ÇíÈùûË°®Á§∫„Å´„Åô„Çã
      } else stopCamera();
    }
  };

  const handleStartCountdown = () => {
    if (countdown !== null) return; // „Ç´„Ç¶„É≥„Éà„ÉÄ„Ç¶„É≥‰∏≠„ÅØÂÆüË°å„Åó„Å™„ÅÑ

    let count = 5;
    setCountdown(count);

    // 5„ÅÆ„Çø„Ç§„Éü„É≥„Ç∞„Åß‰∏ÄÂ∫¶„Å†„ÅëÈü≥„ÇíÈ≥¥„Çâ„Åô
    if (countdown54321SoundRef.current) {
      countdown54321SoundRef.current.currentTime = 0;
      countdown54321SoundRef.current.play().catch(e => console.error("54321„Ç´„Ç¶„É≥„Éà„ÉÄ„Ç¶„É≥Èü≥„ÅÆÂÜçÁîü„Å´Â§±Êïó:", e));
    }

    const intervalId = setInterval(() => {
      count -= 1;
      setCountdown(count);
      if (count === 0) {
        clearInterval(intervalId);
        // „Éï„É©„ÉÉ„Ç∑„É•„ÇíÁÑö„ÅÑ„Å¶„Åã„ÇâÊíÆÂΩ±
        setShowFlash(true);
        // DOM„ÅÆÊõ¥Êñ∞„ÇíÂæÖ„Å£„Å¶„Åã„ÇâÊíÆÂΩ±„Åô„Çã„Åü„ÇÅ„Å´Â∞ë„ÅóÈÅÖÂª∂„Åï„Åõ„Çã
        setTimeout(() => {
          capturePhoto();
        }, 100);
      }
    }, 1000);
  };

  const handleUsePhoto = () => {
    setShowLargePreview(false);
    stopCamera();
  };

  const handleTakePhoto = () => {
    if (!accessToken) {
      alert("ÂÖà„Å´Google„É≠„Ç∞„Ç§„É≥„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ");
      return;
    }
    const isPC = !/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
    if (isPC) {
      // PC„ÅÆÂ†¥Âêà„ÅØ„É¢„Éº„ÉÄ„É´„Ç´„É°„É©„ÇíËµ∑Âãï
      startCamera();
    } else {
      // „Çπ„Éû„Éõ„ÅÆÂ†¥Âêà„ÅØOSÊ®ôÊ∫ñ„ÅÆ„Éï„Ç°„Ç§„É´ÈÅ∏Êäû/„Ç´„É°„É©„ÇíËµ∑Âãï
      uploadPhoto((dataUrl) => {
        setImagePreviewUrl(dataUrl);
        setPhotoDataUrl(dataUrl);
        setFolderName(null); // ÂâçÂõû„ÅÆ„Éï„Ç©„É´„ÉÄÂêç„É™„Çª„ÉÉ„Éà
      });
    }
  };

  const sendNotification = async (folderId, folderName, photoCount) => {
    try {
      const notificationsRef = ref(database, 'notifications');
      const newNotificationRef = push(notificationsRef);

      await set(newNotificationRef, {
        type: 'new_folder',
        folderId: folderId,
        folderName: folderName,
        photoCount: photoCount,
        timestamp: Date.now(),
        completed: false,
        read: false,
        purchased: false
      });

      console.log('ÈÄöÁü•ÈÄÅ‰ø°ÊàêÂäü:', { folderName, photoCount });
    } catch (error) {
      console.error('ÈÄöÁü•ÈÄÅ‰ø°„Ç®„É©„Éº:', error);
    }
  };

  const handleUpload = async () => {
    if (!photoDataUrl || !accessToken) return;
    console.log('üì∏ ÈÅ∏Êäû„Åï„Çå„Åü‰∫∫Êï∞:', photoCount);
    try {
      setIsUploading(true);
      await initializeGapi();
      window.gapi.client.setToken({ access_token: accessToken });

      const raw = `${new Date().toTimeString().slice(0, 8).replace(/:/g, '')}${Math.floor(Math.random() * 90 + 10)}`;
      const newFolderName = `${raw.slice(0, 4)}-${raw.slice(4)}`;
      const subFolderId = await createDriveSubFolder(PARENT_FOLDER_ID, newFolderName, accessToken);

      await uploadImageToDrive(subFolderId, photoDataUrl, accessToken, "Realphoto");

      const qr = await generateQRCode(subFolderId);
      await uploadImageToDrive(subFolderId, qr, accessToken, "qr");

      if (newFolderName) {
        await sendNotification(subFolderId, newFolderName, photoCount);
      }

      setFolderName(newFolderName);
    } catch (err) {
      console.error("„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ„Ç®„É©„Éº:", err);
      alert("„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ„Å´Â§±Êïó„Åó„Åæ„Åó„Åü");
    } finally {
      setIsUploading(false);
    }
  };

  return (
    <>
      <div className="w-full flex flex-col items-center">
        <h1 className="text-center text-xl font-bold m-8">ÂÜôÁúü„Çí„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ„Åó„Å¶„Å≠ÔºÅ</h1>

        {!accessToken ? (
          <StitchButton onClick={handleLogin}>Google„Å´„É≠„Ç∞„Ç§„É≥</StitchButton>
        ) : (
          <StitchButton onClick={handleTakePhoto} disabled={isUploading}>ÂÜôÁúü„ÇíÊíÆ„Çã</StitchButton>
        )}

        <div className="flex justify-center w-full m-6">
          <div className="flex justify-center items-center w-[500px] h-[500px] border-2 border-dashed border-gray-400 p-2">
            {imagePreviewUrl && (
              <img
                src={imagePreviewUrl}
                alt="preview"
                className="max-w-full max-h-full object-contain"
              />
            )}
          </div>
        </div>

        {photoDataUrl && !folderName && (
          <>
            <div className="mb-4 w-full max-w-md">
              <label className="block text-sm font-bold mb-2">‰∫∫Êï∞„ÇíÈÅ∏ÊäûÔºö</label>
              <select
                value={photoCount}
                onChange={(e) => setPhotoCount(Number(e.target.value))}
                className="border rounded px-4 py-2 w-full"
              >
                {[1, 2, 3, 4, 5, 6, 7, 8, 9, 10].map(num => (
                  <option key={num} value={num}>{num}Êûö</option>
                ))}
              </select>
            </div>
            <StitchButton onClick={handleUpload} disabled={isUploading} className="mt-5 p-8">
              „Ç¢„ÉÉ„Éó„É≠„Éº„Éâ
            </StitchButton>
          </>
        )}

        {isUploading && (
          <div id="fullOverlay" className="fixed inset-0 bg-black bg-opacity-60 flex flex-col items-center justify-center z-50">
            <div className="text-center mt-5">
              <div className="spinner-container">
                <div className="spinner-flip">
                  <div className="spinner-face spinner-front">
                    <img src="ai-cheki.jpg" alt="Front" className="w-full h-full object-cover rounded-xl" />
                  </div>
                  <div className="spinner-face spinner-back">
                    <img src="real.jpg" alt="Back" className="w-full h-full object-cover rounded-xl" />
                  </div>
                </div>
                <p className="mt-2 text-white text-xl font-semibold">„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ‰∏≠...</p>
              </div>
            </div>
          </div>
        )}

        {folderName && (
          <p className="flex flex-col items-center mt-5 mb-5 font-bold text-3xl">
            Âèó‰ªòÁï™Âè∑
            <span className="text-blue-600 text-6xl mt-2">{folderName}</span>
          </p>
        )}
      </div>
      {showCameraModal && (
        <div className="fixed inset-0 bg-black z-50">
          {showLargePreview ? (
            <>
              <img src={imagePreviewUrl} alt="Captured" className="w-full h-full object-contain" />
              <div className="absolute bottom-10 left-0 right-0 flex justify-center items-center gap-8">
                <StitchButton onClick={handleUsePhoto}>OK</StitchButton>
              </div>
            </>
          ) : (
            <>
              <video
                ref={el => {
                  videoRef.current = el; // videoRef„ÅØÂºï„ÅçÁ∂ö„Åç‰øùÊåÅ
                  if (el && stream) {
                    el.srcObject = stream;
                  }
                }}
                autoPlay
                playsInline
                className="w-full h-full object-contain transform -scale-x-100"></video>

              {/* „Ç´„É°„É©Ê≥®ÁõÆÁî®„ÅÆ„Ç§„É≥„Ç∏„Ç±„Éº„Çø„Éº */}
              {countdown !== null && countdown > 0 && (
                <div className="absolute top-6 left-1/2 -translate-x-1/2 flex items-center flex-col pointer-events-none">
                  <div className="text-red-500 text-8xl animate-pulse">‚ñ≤</div>
                </div>
              )}

              {/* „Ç´„Ç¶„É≥„Éà„ÉÄ„Ç¶„É≥‰∏≠„ÅÆÁôΩ„ÅÑÈùÑ„Ç®„Éï„Çß„ÇØ„Éà */}
              {showCountdownEffect && (
                <div className="absolute inset-0 bg-white opacity-30">
                </div>
              )}

              {/* „Éï„É©„ÉÉ„Ç∑„É•Áî®„ÅÆ„Ç™„Éº„Éê„Éº„É¨„Ç§ */}
              {showFlash && (
                <div className="absolute inset-0 bg-white z-10"></div>
              )}

              {/* „Ç´„Ç¶„É≥„Éà„ÉÄ„Ç¶„É≥Ë°®Á§∫ */}
              {countdown !== null && countdown > 0 && (
                <div className="absolute inset-0 flex items-center justify-between px-16 pointer-events-none">
                  <span className="text-white text-[60vh] font-bold leading-none" style={{ textShadow: '0 0 50px rgba(0,0,0,0.8)' }}>
                    {countdown}
                  </span>
                  <span className="text-white text-[60vh] font-bold leading-none" style={{ textShadow: '0 0 50px rgba(0,0,0,0.8)' }}>
                    {countdown}
                  </span>
                </div>
              )}

              {/* Êìç‰Ωú„Éú„Çø„É≥ */}
              <div className="absolute bottom-10 left-0 right-0 flex justify-start items-center gap-8 pl-10">
                <StitchButton onClick={handleStartCountdown} disabled={countdown !== null}>
                  ÊíÆÂΩ±
                </StitchButton>
                <button
                  onClick={stopCamera}
                  disabled={countdown !== null}
                  className="px-6 py-3 rounded-lg bg-gray-600 bg-opacity-80 text-white font-bold text-lg disabled:opacity-50"
                >
                  „Ç≠„É£„É≥„Çª„É´
                </button>
                <button
                  onClick={handleToggleAspectRatio}
                  disabled={countdown !== null}
                  className="px-6 py-3 rounded-lg bg-blue-600 bg-opacity-80 text-white font-bold text-lg disabled:opacity-50"
                >
                  {aspectRatio === '4:3' ? 'Á∏¶Èï∑„Å´Â§âÊõ¥' : 'Ê®™Èï∑„Å´Â§âÊõ¥'}
                </button>
              </div>
            </>
          )}
          <canvas ref={canvasRef} className="hidden"></canvas>
        </div>
      )}
    </>
  );
}

export default Camera;
